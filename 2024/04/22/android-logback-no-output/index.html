<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Android｜记一个导致 logback 无法输出日志的问题 &mdash; 朱</title><link rel="stylesheet" href="https://zwany1.github.io/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://zwany1.github.io/assets/css/components/collection.css"><link rel="stylesheet" href="https://zwany1.github.io/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://zwany1.github.io/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://zwany1.github.io/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://zwany1.github.io/assets/css/globals/common.css"><link rel="stylesheet" href="https://zwany1.github.io/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://zwany1.github.io/assets/css/posts/index.css"><link rel="stylesheet" href="https://zwany1.github.io/assets/css/globals/animations.css"><link rel="stylesheet" href="https://zwany1.github.io/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://mazhuang.org/rouge-themes/dist/github.css"><link rel="canonical" href="https://zwany1.github.io/2024/04/22/android-logback-no-output/"><link rel="alternate" type="application/atom+xml" title="朱" href="https://zwany1.github.io/feed.xml"><link rel="shortcut icon" href="https://zwany1.github.io/assets/images/d56012bab88f5aabe76bb1fc7eeeb9c6.jpg"><meta property="og:title" content="Android｜记一个导致 logback 无法输出日志的问题"><meta name="keywords" content="Android, logback"><meta name="og:keywords" content="Android, logback"><meta name="description" content="之前写过《Android｜集成 slf4j + logback 作为日志框架》，最近在给手上的另外一个 Android 项目添加 logback 日志框架时，遇到一个导致无法输出日志到文件的问题，也耽误了不少时间，这里记录一下。"><meta name="og:description" content="之前写过《Android｜集成 slf4j + logback 作为日志框架》，最近在给手上的另外一个 Android 项目添加 logback 日志框架时，遇到一个导致无法输出日志到文件的问题，也耽误了不少时间，这里记录一下。"><meta property="og:url" content="https://zwany1.github.io/2024/04/22/android-logback-no-output/"><meta property="og:site_name" content="朱"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2024-04-22"> <script src="https://zwany1.github.io/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://zwany1.github.io/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container">
<h1><a href="https://zwany1.github.io/" title="朱"><span class="octicon octicon-mark-github"></span> 朱</a></h1>
<button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://zwany1.github.io/" class="site-header-nav-item" target="" title="首页">首页</a> <a href="https://zwany1.github.io/categories/" class="site-header-nav-item" target="" title="分类">分类</a> <a href="https://zwany1.github.io/archives/" class="mobile-hidden site-header-nav-item" target="" title="归档">归档</a> <a href="https://zwany1.github.io/open-source/" class="mobile-hidden site-header-nav-item" target="" title="开源">开源</a> <a href="https://zwany1.github.io/fragments/" class="site-header-nav-item" target="" title="片段">片段</a> <a href="https://zwany1.github.io/wiki/" class="site-header-nav-item" target="" title="维基">维基</a> <a href="https://zwany1.github.io/links/" class="mobile-hidden site-header-nav-item" target="" title="链接">链接</a> <a href="https://zwany1.github.io/about/" class="site-header-nav-item" target="" title="关于">关于</a> <a class="mobile-hidden" href="https://zwany1.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></nav>
</div></header><section class="collection-head small geopattern" data-pattern-id="Android｜记一个导致 l"><div class="container"><div class="columns">
<div class="column three-fourths"><div class="collection-title">
<h1 class="collection-header">Android｜记一个导致 logback 无法输出日志的问题</h1>
<div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2024/04/22 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://zwany1.github.io/categories/#Android" title="Android">Android</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2434 字，约 7 分钟 </span>
</div>
</div></div>
<div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://zwany1.github.io/assets/images/qrcode.jpg" alt="朱猪写作">
</div></div>
</div></div></section><section class="container content"><div class="columns">
<div class="column three-fourths">
<article class="article-content markdown-body"><p>之前写过<a href="https://mp.weixin.qq.com/s/kMRkQ6j-ipet85si-rbfyw">《Android｜集成 slf4j + logback 作为日志框架》</a>，最近在给手上的另外一个 Android 项目添加 logback 日志框架时，遇到一个导致无法输出日志到文件的问题，也耽误了不少时间，这里记录一下。</p>
<h2 id="现象">现象</h2>
<p>代码里通过 <code class="language-plaintext highlighter-rouge">@Slf4j</code> 注解注入 logger，正常 <code class="language-plaintext highlighter-rouge">log.info(xxx)</code>，但是程序启动后，发现没有生成日志文件。</p>
<h2 id="排查">排查</h2>
<h3 id="检查配置文件">检查配置文件</h3>
<p>有前一个项目的成功经验，我直接复制了之前项目的配置文件，只是将日志存储文件夹修改为了 <code class="language-plaintext highlighter-rouge">${DATA_DIR}/log</code>，其中 <code class="language-plaintext highlighter-rouge">DATA_DIR</code> 变量是指代 <code class="language-plaintext highlighter-rouge">Context.getFilesDir()</code>，它也不存在权限申请之类的问题。测试了将它写死成一个绝对路径，也没有日志文件生成。</p>
<p>基本排除配置文件的问题。</p>
<h3 id="打开-logback-的-debug-模式">打开 logback 的 debug 模式</h3>
<p>将 logback.xml 文件的根元素 <code class="language-plaintext highlighter-rouge">&lt;configuration&gt;</code> 添加 <code class="language-plaintext highlighter-rouge">debug="true"</code> 属性，重启程序，查看 logcat 输出，发现如下异常：</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11:34:06,785 |-ERROR <span class="k">in </span>ch.qos.logback.core.rolling.RollingFileAppender[local_file] - Failed to create parent directories <span class="k">for</span> <span class="o">[</span>/log/app.log]
11:34:06,786 |-ERROR <span class="k">in </span>ch.qos.logback.core.rolling.RollingFileAppender[local_file] - openFile<span class="o">(</span>/log/student.log,true<span class="o">)</span> failed java.io.FileNotFoundException: /log/app.log: open failed: ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
	at java.io.FileNotFoundException: /log/student.log: open failed: ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
        ...
	at 	at org.slf4j.LoggerFactory.getLogger<span class="o">(</span>LoggerFactory.java:416<span class="o">)</span>
	at 	at org.mazhuang.OnlineApplication.&lt;clinit&gt;<span class="o">(</span>OnlineApplication.java:21<span class="o">)</span>
</code></pre></div></div>
<p>初始化日志文件路径失败，但是输出的日志文件路径是 <code class="language-plaintext highlighter-rouge">/log/app.log</code>，而不是我配置的 <code class="language-plaintext highlighter-rouge">${DATA_DIR}/log/app.log</code>，这里有问题。</p>
<p>可以看出是 logback 没有正确解析 <code class="language-plaintext highlighter-rouge">${DATA_DIR}</code> 变量，导致日志文件路径错误。但是为什么会这样呢？并没有什么头绪，难道是 logback 的 bug？</p>
<h3 id="检查-logback-android-的-wiki">检查 logback-android 的 wiki</h3>
<p>在想了好久仍然没有头绪之后，浏览 logback-android 的 wiki，发现在介绍 <code class="language-plaintext highlighter-rouge">DATA_DIR</code> 等变量的地方，有这么一段以前没留意的描述：</p>
<blockquote><p>Note these special properties are initialized when the first logger is instantiated (i.e., via LoggerFactory.getLogger()), but that must be done when the application context is available (e.g., in the onCreate method of your Application class or at any point thereafter). Otherwise, the special properties will resolve to empty strings.</p></blockquote>
<p>这段话大意是，<code class="language-plaintext highlighter-rouge">DATA_DIR</code> 等这些变量，是在第一次调用 <code class="language-plaintext highlighter-rouge">LoggerFactory.getLogger()</code> 时初始化的，但是必须在 application context 可用之后（例如在 Application 类的 <code class="language-plaintext highlighter-rouge">onCreate</code> 方法中或之后的任何时候）。否则，这些变量将解析为空字符串。</p>
<p>结合上面异常堆栈里的信息，可以判断是因为在 Application 类的类初始化（<code class="language-plaintext highlighter-rouge">clinit</code>）过程中调用了 <code class="language-plaintext highlighter-rouge">LoggerFactory.getLogger()</code>，此时 application context 还不可用，导致 logback 无法正确解析 <code class="language-plaintext highlighter-rouge">${DATA_DIR}</code> 变量。</p>
<h3 id="进一步探究">进一步探究</h3>
<p>而为什么 Application 类的类初始化过程中会调用 <code class="language-plaintext highlighter-rouge">LoggerFactory.getLogger()</code> 呢？检查代码，发现是在自定义 Application 类及其基类中使用了 <code class="language-plaintext highlighter-rouge">@Slf4j</code> 注解，这个注解会生成一个静态的 logger，而这个 logger 的初始化会调用 <code class="language-plaintext highlighter-rouge">LoggerFactory.getLogger()</code>——太早了。</p>
<p>参见 <code class="language-plaintext highlighter-rouge">@Slf4j</code> 注解源文件里的注释：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Causes lombok to generate a logger field.
Complete documentation is found at the project lombok features page for lombok log annotations .
Example:
  @Slf4j
  public class LogExample {
  }
  
will generate:
  public class LogExample {
      private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(LogExample.class);
  }
</code></pre></div></div>
<h2 id="解决">解决</h2>
<p>去掉自定义 Application 类及其基类上的 <code class="language-plaintext highlighter-rouge">@Slf4j</code> 注解，如果需要在 Application 类里打印日志，改为在 <code class="language-plaintext highlighter-rouge">onCreate</code> 方法中手动初始化 logger。</p>
<p>又一次印证了认真阅读文档的重要性。<img class="emoji" title=":cry:" alt=":cry:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f622.png" height="20" width="20"></p>
<h2 id="参考">参考</h2>
<ul><li><a href="https://github.com/tony19/logback-android/wiki#special-properties-for-xml-config">https://github.com/tony19/logback-android/wiki#special-properties-for-xml-config</a></li></ul>
<div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7">
<h3>文档信息</h3>
<ul>
<li>本文作者：<a href="https://zwany1.github.io" target="_blank">朱</a>
</li>
<li>本文链接：<a href="https://zwany1.github.io/2024/04/22/android-logback-no-output/" target="_blank">https://zwany1.github.io/2024/04/22/android-logback-no-output/</a>
</li>
<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li>
</ul>
</div></article><div class="share"></div>
<div class="comment"> <script src="https://utteranc.es/client.js" repo="zwany1/zwany1.github.io" issue-term="title" label="gitment" theme="github-light" crossorigin="anonymous" async> </script>
</div>
</div>
<div class="column one-fourth">
<h3>Search</h3>
<div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search">
</div>
<ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul>
<script src="https://zwany1.github.io/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://zwany1.github.io/assets/search_data.json?v=1765177236', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3>
<div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div>
<script src="https://zwany1.github.io/assets/js/jquery.toc.js"></script>
</div>
</div></section><footer class="container"><div class="site-footer" role="contentinfo">
<div class="copyright left mobile-block"> © 2025 <span title="朱">朱</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
</div>
<ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)">TOP</a>
</li></ul>
<a href="https://github.com/zwany1/zwany1.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden">
<li> <a href="https://zwany1.github.io/" title="首页" target="">首页</a>
</li>
<li> <a href="https://zwany1.github.io/categories/" title="分类" target="">分类</a>
</li>
<li> <a href="https://zwany1.github.io/archives/" title="归档" target="">归档</a>
</li>
<li> <a href="https://zwany1.github.io/open-source/" title="开源" target="">开源</a>
</li>
<li> <a href="https://zwany1.github.io/fragments/" title="片段" target="">片段</a>
</li>
<li> <a href="https://zwany1.github.io/wiki/" title="维基" target="">维基</a>
</li>
<li> <a href="https://zwany1.github.io/links/" title="链接" target="">链接</a>
</li>
<li> <a href="https://zwany1.github.io/about/" title="关于" target="">关于</a>
</li>
<li><a href="https://zwany1.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
</ul>
</div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a>
</div><script src="https://zwany1.github.io/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
