<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="https://zwany1.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://zwany1.github.io/" rel="alternate" type="text/html" /><updated>2025-12-08T15:00:32+08:00</updated><id>https://zwany1.github.io/feed.xml</id><title type="html">朱</title><subtitle>朱的个人博客，公众号：朱猪写作</subtitle><author><name>朱</name></author><entry><title type="html">借助 Let’s Encrypt 节省 SSL 证书费用</title><link href="https://zwany1.github.io/2025/11/27/save-money-via-letsencrypt/" rel="alternate" type="text/html" title="借助 Let’s Encrypt 节省 SSL 证书费用" /><published>2025-11-27T00:00:00+08:00</published><updated>2025-11-27T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/11/27/save-money-via-letsencrypt</id><content type="html" xml:base="https://zwany1.github.io/2025/11/27/save-money-via-letsencrypt/"><![CDATA[<p>向服务商购买一张常见的 DV 通配符 SSL 证书，通常每年价格在数百至一千多元人民币不等；若名下有多个域名需要使用证书，总费用每年可能达到数千元。</p>

<p>在当前强调降本增效的环境下，若评估后认为免费证书能够满足需求，小公司和个人网站即可节省相应成本。</p>

<h2 id="lets-encrypt-简介">Let’s Encrypt 简介</h2>

<p>Let’s Encrypt 是一家免费、开放、自动化的公益性证书颁发机构（CA），由互联网安全研究组（ISRG）运作，属于非营利组织。其目标是推广 HTTPS 的应用，为构建更安全、尊重隐私的互联网提供免费而便捷的支持。</p>

<h2 id="操作方法">操作方法</h2>

<p>根据不同使用环境，Let’s Encrypt 提供多种验证与获取证书的方式。常用工具是 Certbot，详见文档：<a href="https://eff-certbot.readthedocs.io/en/stable/">https://eff-certbot.readthedocs.io/en/stable/</a>。</p>

<p>在部分环境中，可配置工具定期自动续期，减少维护工作。</p>

<p>由于服务器环境较为老旧，且需要将证书上传至阿里云并部署到多个云服务，本文暂采用“本地生成证书—手动上传与更新”的方式。</p>

<h3 id="0x01-在本地生成证书">0x01 在本地生成证书</h3>

<p>本文使用 Docker 运行 Certbot，参见文档：<a href="https://eff-certbot.readthedocs.io/en/stable/install.html#alternative-1-docker">https://eff-certbot.readthedocs.io/en/stable/install.html#alternative-1-docker</a>。</p>

<p>生成通配符证书的示例命令如下：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--name</span> certbot <span class="se">\</span>
  <span class="nt">-v</span> <span class="s1">'/Users/mazhuang/some/path/letsencrypt:/etc/letsencrypt'</span> <span class="se">\</span>
  certbot/certbot certonly <span class="se">\</span>
  <span class="nt">--preferred-challenges</span> dns <span class="se">\</span>
  <span class="nt">--manual</span> <span class="se">\</span>
  <span class="nt">--server</span> https://acme-v02.api.letsencrypt.org/directory <span class="se">\</span>
  <span class="nt">--key-type</span> rsa <span class="nt">--rsa-key-size</span> 2048
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">--preferred-challenges dns</code>：使用 DNS 方式进行域名验证；</li>
  <li><code class="language-plaintext highlighter-rouge">--manual</code>：以交互式方式进行询问与操作；</li>
  <li><code class="language-plaintext highlighter-rouge">--key-type rsa --rsa-key-size 2048</code>：生成 2048 位 RSA 私钥（部分阿里云服务不支持默认的 ECC 证书）。</li>
</ul>

<p>执行后会依次询问邮箱、协议授权、域名等信息，随后提示添加 DNS TXT 记录以完成域名所有权验证，按提示操作即可。</p>

<p>生成成功后，证书与私钥保存在挂载的本地目录中，例如上述命令中的 <code class="language-plaintext highlighter-rouge">/Users/mazhuang/some/path/letsencrypt/archive/{domain name}</code>。各文件的说明可参考：<a href="https://eff-certbot.readthedocs.io/en/stable/using.html#where-certs">https://eff-certbot.readthedocs.io/en/stable/using.html#where-certs</a>。</p>

<h3 id="0x02-上传和部署证书">0x02 上传和部署证书</h3>

<p>将证书上传到阿里云的数字证书管理服务。可使用其一键部署功能（付费），或在各云服务中手动选择使用该证书（免费），按需取用。</p>

<h3 id="0x03-定期更新证书">0x03 定期更新证书</h3>

<p>Let’s Encrypt 颁发的证书有效期为 90 天，建议在到期前 30 天内更新。可重复步骤 0x01 生成新证书，然后上传并部署。</p>

<h2 id="注意事项">注意事项</h2>

<p>部分极为老旧的平台有可能不支持 Let’s Encrypt 颁发的证书，建议评估后再决定是否使用，具体的兼容情况可以参考：<a href="https://letsencrypt.org/zh-cn/docs/certificate-compatibility/">https://letsencrypt.org/zh-cn/docs/certificate-compatibility/</a> 。</p>

<p>比如我这边就遇到了因为使用的是 JDK 8 的低于 141 的版本，部署完证书后，发现 xxl-job 定时任务执行器没有注册上，报错 <code class="language-plaintext highlighter-rouge">sun.security.validator.ValidatorException: PKIX path building failed</code>。</p>

<p>解决方法：</p>

<ol>
  <li>
    <p>下载 ISRG Root X1 证书</p>

    <p>在这里可以找到： https://letsencrypt.org/certificates/</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">cd</span> /opt
 get https://letsencrypt.org/certs/isrgrootx1.pem
</code></pre></div>    </div>
  </li>
  <li>
    <p>导入证书到 JDK 的 cacerts 中</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code> keytool <span class="nt">-trustcacerts</span> <span class="nt">-keystore</span> <span class="s2">"/opt/jdk/jre/lib/security/cacerts"</span> <span class="nt">-storepass</span> changeit <span class="nt">-noprompt</span> <span class="nt">-importcert</span> <span class="nt">-alias</span> lets-encrypt-x1 <span class="nt">-file</span> <span class="s2">"/opt/isrgrootx1.pem"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>重启服务</p>
  </li>
</ol>

<h2 id="小结">小结</h2>

<p>以上步骤简单、成本为零。对小公司和个人网站而言，是节省 SSL 证书费用的可行方案。</p>

<p>若环境允许，建议配置自动化续期，进一步降低维护成本，按需采用。</p>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li>https://letsencrypt.org/zh-cn/</li>
  <li>https://eff-certbot.readthedocs.io/en/stable/</li>
</ul>]]></content><author><name>朱</name></author><category term="DevOps" /><summary type="html"><![CDATA[小公司和个人网站如何借助 Let's Encrypt 免费获取 SSL 证书，从而节省成本。]]></summary></entry><entry><title type="html">解决访问 https 网站时，后端重定向或获取 URL 变成 http 的问题</title><link href="https://zwany1.github.io/2025/11/14/https-redirect-http-problem-in-nginx/" rel="alternate" type="text/html" title="解决访问 https 网站时，后端重定向或获取 URL 变成 http 的问题" /><published>2025-11-14T00:00:00+08:00</published><updated>2025-11-14T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/11/14/https-redirect-http-problem-in-nginx</id><content type="html" xml:base="https://zwany1.github.io/2025/11/14/https-redirect-http-problem-in-nginx/"><![CDATA[<p>一种常见的服务部署架构是 Nginx 反向代理后端 Java 应用服务器，Nginx 监听 443 端口处理 https 请求，然后转发给后端服务器。</p>

<p><img src="/images/posts/nginx/https-nginx-http-java.drawio.png" alt="" /></p>

<p>对应的 Nginx 配置大致如下：</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">upstream</span> <span class="s">www</span> <span class="p">{</span>
    <span class="kn">server</span> <span class="nf">192.168.1.101</span><span class="p">:</span><span class="mi">8080</span>  <span class="s">weight=100</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=10s</span><span class="p">;</span>
    <span class="kn">server</span> <span class="nf">192.168.1.102</span><span class="p">:</span><span class="mi">8080</span>  <span class="s">weight=100</span> <span class="s">max_fails=3</span> <span class="s">fail_timeout=10s</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>

    <span class="kn">ssl_certificate</span> <span class="n">/path/to/cert.pem</span><span class="p">;</span>
    <span class="kn">ssl_certificate_key</span> <span class="n">/path/to/key.pem</span><span class="p">;</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://www</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>即：客户端与 Nginx 之间是 https，Nginx 与后端 Java 应用服务器之间是 http。</p>

<p>这样可能会遇到一些问题，如：</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">HttpServletRequest.getRequestURL()</code> 获取到的 URL 是 Nginx 与后端服务器之间的 http URL，比如 <code class="language-plaintext highlighter-rouge">http://192.168.1.101:8080/xxx</code>；</li>
  <li><code class="language-plaintext highlighter-rouge">HttpServletResponse.sendRedirect()</code> 生成的重定向 URL 也是 http URL。</li>
</ol>

<p>要解决这些问题，可以通过 Nginx 配置 + 少量后端代码修改来实现。</p>

<h2 id="解决应用中获取到的-url-的问题">解决应用中获取到的 URL 的问题</h2>

<p>用户实际访问的是 <code class="language-plaintext highlighter-rouge">https://example.com/xxx</code>，但是后端应用获取到的 URL 是 <code class="language-plaintext highlighter-rouge">http://192.168.1.101:8080/xxx</code>，如何让后端应用获取到正确的 URL 呢？</p>

<p>第一步，Nginx 可以通过 <code class="language-plaintext highlighter-rouge">proxy_set_header Host</code> 指令将客户端请求的 Host 头传递给后端服务器：</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="c1"># ...</span>
    <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这样，后端应用通过 <code class="language-plaintext highlighter-rouge">HttpServletRequest.getRequestURL()</code> 获取到的 URL 就是 <code class="language-plaintext highlighter-rouge">http://example.com/xxx</code> 了。</p>

<p>但此时，协议仍然不对，还是 http。</p>

<p>要给后端应用传递正确的协议，通常的做法是使用 <code class="language-plaintext highlighter-rouge">X-Forwarded-Proto</code> 头：</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="c1"># ...</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>添加这个头之后并不会让 <code class="language-plaintext highlighter-rouge">HttpServletRequest.getRequestURL()</code> 直接返回 https URL，需要在后端应用中做一些处理。以 Java 应用为例，可以通过一个过滤器（Filter）来修改 request 的 scheme：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">javax.servlet.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequestWrapper</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.lang3.StringUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XForwardedProtoFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="k">instanceof</span> <span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">HttpServletRequest</span> <span class="n">httpRequest</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
            <span class="nc">String</span> <span class="n">xForwardedProto</span> <span class="o">=</span> <span class="n">httpRequest</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"X-Forwarded-Proto"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">xForwardedProto</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xForwardedProto</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">httpRequest</span><span class="o">.</span><span class="na">getScheme</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="n">xForwardedProto</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"https"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">httpRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HttpServletRequestWrapper</span><span class="o">(</span><span class="n">httpRequest</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getScheme</span><span class="o">()</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">xForwardedProto</span><span class="o">;</span>
                    <span class="o">}</span>

                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="nc">StringBuffer</span> <span class="nf">getRequestURL</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nc">StringBuffer</span> <span class="n">requestURL</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">getRequestURL</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">requestURL</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">requestURL</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">requestURL</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"://"</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">requestURL</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">xForwardedProto</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                        <span class="k">return</span> <span class="n">requestURL</span><span class="o">;</span>
                    <span class="o">}</span>
                    
                <span class="o">};</span>
            <span class="o">}</span>
            <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">httpRequest</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>至此，后端应用通过 <code class="language-plaintext highlighter-rouge">HttpServletRequest.getRequestURL()</code> 获取到的 URL 就是 <code class="language-plaintext highlighter-rouge">https://example.com/xxx</code> 了。</p>

<h2 id="解决重定向-url-的问题">解决重定向 URL 的问题</h2>

<p>后端应用通过 <code class="language-plaintext highlighter-rouge">HttpServletResponse.sendRedirect()</code> 生成的重定向 URL 也是 http URL，如何让它变成 https 呢？</p>

<p>这个问题可以通过 Nginx 的另一指令 <code class="language-plaintext highlighter-rouge">proxy_redirect</code> 来解决，该指令用于修改从后端服务器返回的 <code class="language-plaintext highlighter-rouge">Location</code> 和 <code class="language-plaintext highlighter-rouge">Refresh</code> 响应头。</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="c1"># ...</span>
    <span class="kn">proxy_redirect</span> <span class="s">http://</span> <span class="nv">$scheme</span><span class="p">:</span><span class="n">//</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这样，当后端应用返回一个重定向响应时，Nginx 会将 <code class="language-plaintext highlighter-rouge">Location</code> 头中的 <code class="language-plaintext highlighter-rouge">http://</code> 替换为 <code class="language-plaintext highlighter-rouge">$scheme://</code>，即 <code class="language-plaintext highlighter-rouge">https://</code>。</p>

<h2 id="进一步思考当-nginx-前面还有负载均衡器时">进一步思考：当 Nginx 前面还有负载均衡器时</h2>

<p>在很多情况下，Nginx 前面可能还有商用负载均衡器（如 AWS ELB、阿里云 SLB 等），这时需要考虑负载均衡器与 Nginx 之间的协议问题。</p>

<p>如果负载均衡器与 Nginx 之间是 http，而 Nginx 与后端应用之间是 http，那么就需要在负载均衡器和 Nginx 之间添加 <code class="language-plaintext highlighter-rouge">X-Forwarded-Proto</code> 头，以便 Nginx 能够正确地识别原始请求的协议。</p>

<p>主流的负载均衡器配置项里应该都有添加 <code class="language-plaintext highlighter-rouge">X-Forwarded-Proto</code> 头的选项开关，比如阿里云：</p>

<p><img src="/images/posts/nginx/alicloud-clb-x-forwarded-proto.png" alt="" /></p>

<p>需要注意的是这样配置后，Nginx 配置也需要做相应的调整，将 <code class="language-plaintext highlighter-rouge">$scheme</code> 替换为 <code class="language-plaintext highlighter-rouge">$http_x_forwarded_proto</code>：
（此种场景 <code class="language-plaintext highlighter-rouge">$scheme</code> 为负载均衡器与 Nginx 之间的协议 http，<code class="language-plaintext highlighter-rouge">$http_x_forwarded_proto</code> 为负载均衡器通过 Header 透传过来的前端访问协议 https。）</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">location</span> <span class="n">/</span> <span class="p">{</span>
    <span class="c1"># ...</span>
    <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$http_x_forwarded_proto</span><span class="p">;</span>
    <span class="kn">proxy_redirect</span> <span class="s">http://</span> <span class="nv">$http_x_forwarded_proto</span><span class="p">:</span><span class="n">//</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header">Nginx 官方文档 - proxy_set_header</a></li>
  <li><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect">Nginx 官方文档 - proxy_redirect</a></li>
  <li><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#variables">Nginx 官方文档 - Embedded Variables</a></li>
</ul>]]></content><author><name>朱</name></author><category term="Java" /><summary type="html"><![CDATA[解决访问 https 网站时，后端重定向或获取 URL 变成 http 的问题]]></summary></entry><entry><title type="html">清除 GitHub 上的幽灵通知</title><link href="https://zwany1.github.io/2025/10/15/clean-github-ghost-notifications/" rel="alternate" type="text/html" title="清除 GitHub 上的幽灵通知" /><published>2025-10-15T00:00:00+08:00</published><updated>2025-10-15T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/10/15/clean-github-ghost-notifications</id><content type="html" xml:base="https://zwany1.github.io/2025/10/15/clean-github-ghost-notifications/"><![CDATA[<p>最近我的 GitHub 页面右上角一直有个小蓝点，就像这样：</p>

<p><img src="/images/posts/github/github-ghost-notifications.png" alt="" /></p>

<p>这是有未读通知的指示，但点进去却什么也看不到。</p>

<p><img src="/images/posts/github/github-ghost-notifications-empty-list.png" alt="" /></p>

<p>这种「幽灵通知」已经干扰了我的正常使用体验。这天实在忍无可忍，正打算给 GitHub 提交一个工单时，在官方开设的讨论区里发现了一个讨论贴，我在里面找到了有效的临时解决办法，特此记录下来以备后用。</p>

<p>讨论贴链接：<a href="https://github.com/orgs/community/discussions/6874">https://github.com/orgs/community/discussions/6874</a></p>

<h2 id="方案一">方案一</h2>

<p>我使用的是讨论里提到的 <a href="https://github.com/orgs/community/discussions/6874?sort=top#discussioncomment-14507162">利用浏览器开发者工具的解决方案</a>。</p>

<ol>
  <li>
    <p>在浏览器打开通知列表页面，点击左侧标记有数字的 Filters 或者 Repositories，比如我上文贴的图里的 <code class="language-plaintext highlighter-rouge">Participating</code>、<code class="language-plaintext highlighter-rouge">Mentioned</code>，或者 <code class="language-plaintext highlighter-rouge">outcaster552/gitcoinpromosender</code>、<code class="language-plaintext highlighter-rouge">gitcionoda/org</code>、<code class="language-plaintext highlighter-rouge">yycombinator/-co</code>、<code class="language-plaintext highlighter-rouge">paradigm-ventures/paradigm</code> 等等。</p>
  </li>
  <li>
    <p>打开浏览器的开发者工具（F12），切换到 Console 标签页，粘贴以下代码并回车执行：</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">.js-notifications-mark-all-actions</span><span class="dl">'</span><span class="p">).</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">hidden</span><span class="dl">'</span><span class="p">);</span>
 <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">.js-notifications-mark-all-actions form[action="/notifications/beta/archive"] button</span><span class="dl">'</span><span class="p">).</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">disabled</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>这时页面上会出现一个 <code class="language-plaintext highlighter-rouge">Done</code> 按钮，点击它即可清除对应的通知。</p>
  </li>
</ol>

<h2 id="方案二">方案二</h2>

<p>如果以上办法没有解决问题，还可以试一下贴子里 <a href="https://github.com/orgs/community/discussions/6874#discussioncomment-2859125">被标记为答案的回复</a> 是一个借助 curl 命令的解决方案。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> PUT
    <span class="nt">-H</span> <span class="s2">"Accept: application/vnd.github.v3+json"</span> <span class="se">\</span>
    <span class="nt">-H</span> <span class="s2">"Authorization: token </span><span class="nv">$TOKEN</span><span class="s2">"</span> <span class="se">\</span>
     https://api.github.com/notifications <span class="se">\</span>
    <span class="nt">-d</span> <span class="s1">'{"last_read_at":"2025-10-15T10:00:00Z"}'</span>
</code></pre></div></div>

<p>其中 <code class="language-plaintext highlighter-rouge">$TOKEN</code> 需要替换成你自己的 GitHub 个人访问令牌（Personal Access Token），可以在 <a href="https://github.com/settings/tokens/new">https://github.com/settings/tokens/new</a> 创建，注意 Select scopes 里需要勾选 <code class="language-plaintext highlighter-rouge">notifications</code>。命令里的 <code class="language-plaintext highlighter-rouge">last_read_at</code> 字段的值可以按需修改为当前时间。</p>

<h2 id="结语">结语</h2>

<p>这种幽灵通知，看情况应该来自于某些居心不良的开发者，在他们的仓库里恶意 at 大量的用户来引流，然后这些用户就会收到通知。但如果这些仓库后来因为违规被删除，那么这些通知就会变成幽灵通知，无法被正常清除。</p>

<p>看讨论的时间线，这个问题已经存在至少四年了，GitHub 官方似乎并没有打算修复它。希望本文能帮到和我有同样困扰的朋友。</p>]]></content><author><name>朱</name></author><category term="GitHub" /><summary type="html"><![CDATA[清理 GitHub 幽灵通知的一种方法。]]></summary></entry><entry><title type="html">Java｜FreeMarker 复用 layout</title><link href="https://zwany1.github.io/2025/08/30/freemarker-reuse-layout/" rel="alternate" type="text/html" title="Java｜FreeMarker 复用 layout" /><published>2025-08-30T00:00:00+08:00</published><updated>2025-08-30T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/08/30/freemarker-reuse-layout</id><content type="html" xml:base="https://zwany1.github.io/2025/08/30/freemarker-reuse-layout/"><![CDATA[<p>项目里的页面一多，重复的页面布局就不可避免地冒了出来，作为程序员，消除重复，义不容辞。那么，今天就来聊聊如何在 FreeMarker 中复用页面 layout，让代码更优雅、更易维护。</p>

<h2 id="常规做法include">常规做法：include</h2>

<p>FreeMarker 提供了 include 指令，可以把一些公共页面元素单独提取出来，然后在需要的地方通过 include 引入，例如：</p>

<div class="language-ftl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&lt;#--</span><span class="w"> </span>includes/header.ftl --&gt;<span class="w">
</span><span class="err">&lt;</span><span class="no">p</span><span class="err">&gt;我来组成头部&lt;/</span><span class="no">p</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<div class="language-ftl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&lt;#--</span><span class="w"> </span>includes/footer.ftl --&gt;<span class="w">
</span><span class="err">&lt;</span><span class="no">p</span><span class="err">&gt;我来组成底部&lt;/</span><span class="no">p</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<div class="language-ftl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&lt;#--</span><span class="w"> </span>somepage.ftl --&gt;<span class="w">
</span><span class="err">&lt;#</span><span class="no">include</span><span class="w"> </span>"./includes/header.ftl"&gt;<span class="w">

</span><span class="err">&lt;</span><span class="no">p</span><span class="err">&gt;我是页面内容&lt;/</span><span class="no">p</span><span class="err">&gt;</span><span class="w">

</span><span class="err">&lt;#</span><span class="no">include</span><span class="w"> </span>"./includes/footer.ftl"&gt;<span class="w">

</span><span class="err">&lt;</span><span class="no">script</span><span class="err">&gt;</span><span class="w">
</span><span class="err">//</span><span class="w"> </span>这里是一些 JavaScript 代码<span class="w">
</span><span class="err">&lt;/</span><span class="no">script</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<h2 id="去除重复抽象-layout">去除重复：抽象 layout</h2>

<p>但是所有类似的页面都要手写这个结构也挺麻烦的，更糟糕的是，一旦这些页面的结构发生变化，得在 N 个页面里反复修改，想想都头大。</p>

<p>很多博客引擎（比如 Jekyll）都支持 layout 功能，允许我们定义统一的页面布局，具体页面只需专注于内容。</p>

<p>FreeMarker 虽然没有内置 layout，但我们可以用 macro 来实现类似的效果。</p>

<p>比如，抽象出一个 layout/page.ftl 文件，作为布局模板：</p>

<div class="language-ftl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&lt;#--</span><span class="w"> </span>layout/page.ftl --&gt;<span class="w">
</span><span class="err">&lt;#</span><span class="no">macro</span><span class="w"> </span>layout body js=""&gt;<span class="w">

</span><span class="err">&lt;#</span><span class="no">include</span><span class="w"> </span>"../includes/header.ftl" /&gt;<span class="w">

</span><span class="err">${</span><span class="no">body</span><span class="err">}</span><span class="w">

</span><span class="err">&lt;#</span><span class="no">include</span><span class="w"> </span>"../includes/footer.ftl" /&gt;<span class="w">

</span><span class="err">${</span><span class="no">js</span><span class="err">}</span><span class="w">

</span><span class="err">&lt;/#</span><span class="no">macro</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>

<p>然后在需要的页面这样用：</p>

<div class="language-ftl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">&lt;#</span><span class="no">import</span><span class="w"> </span>"./layout/page.ftl" as base&gt;<span class="w">

</span><span class="err">&lt;#</span><span class="no">assign</span><span class="w"> </span>body&gt;<span class="w">

</span><span class="err">&lt;</span><span class="no">p</span><span class="err">&gt;我是页面内容&lt;/</span><span class="no">p</span><span class="err">&gt;</span><span class="w">
</span><span class="err">&lt;</span><span class="no">p</span><span class="err">&gt;当前时间：&lt;</span><span class="no">span</span><span class="w"> </span>id="current-time"&gt;$<span class="p">{</span><span class="na">.now</span><span class="err">?</span><span class="no">string</span><span class="p">(</span><span class="s2">"yyyy-MM-dd HH:mm:ss"</span><span class="p">)}</span>&lt;/span&gt;&lt;/p&gt;<span class="w">

</span><span class="err">&lt;/#</span><span class="no">assign</span><span class="err">&gt;</span><span class="w">

</span><span class="err">&lt;#</span><span class="no">assign</span><span class="w"> </span>js&gt;<span class="w">

</span><span class="err">&lt;</span><span class="no">script</span><span class="err">&gt;</span><span class="w">
</span><span class="err">//</span><span class="w"> </span>每隔一秒刷新当前时间<span class="w">
</span><span class="no">setInterval</span><span class="err">(</span><span class="no">function</span><span class="err">()</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="no">document</span><span class="na">.getElementById</span><span class="p">(</span><span class="s2">"current-time"</span><span class="p">)</span><span class="na">.innerHTML</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">new</span><span class="w"> </span><span class="nb">D</span><span class="no">ate</span><span class="p">()</span><span class="na">.toLocaleString</span><span class="p">()</span><span class="err">;</span><span class="w">
</span><span class="p">}</span>, 1000);<span class="w">
</span><span class="err">&lt;/</span><span class="no">script</span><span class="err">&gt;</span><span class="w">

</span><span class="err">&lt;/#</span><span class="no">assign</span><span class="err">&gt;</span><span class="w">

</span><span class="err">&lt;@</span><span class="no">base</span><span class="na">.layout</span><span class="w"> </span>body=body js=js /&gt;<span class="w">
</span></code></pre></div></div>

<p>页面效果如下：</p>

<p><img src="/images/posts/java/freemarker-layout-page.png" alt="" /></p>

<h2 id="减少手工输入code-snippets">减少手工输入：code snippets</h2>

<p>虽然布局复用问题解决了，但每次新建页面还得手写一遍结构，还是不够优雅。程序员的信条是：能自动化的绝不手动！</p>

<p>这时就轮到编辑器/IDE 的 code snippets 功能登场了。把上面的结构定义成代码片段，新建页面时只需输入一个触发词，基本结构就自动生成。</p>

<p>以 VSCode 为例，可以在项目的 <code class="language-plaintext highlighter-rouge">.vscode</code> 目录下新建 <code class="language-plaintext highlighter-rouge">layout.code-snippets</code> 文件，内容如下：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"page_layout"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ftl"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"prefix"</span><span class="p">:</span><span class="w"> </span><span class="s2">"layout:page"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"body"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"&lt;#import </span><span class="se">\"</span><span class="s2">./layout/page.ftl</span><span class="se">\"</span><span class="s2"> as base&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"&lt;#assign body&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"&lt;/#assign&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"&lt;#assign js&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"&lt;script&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"&lt;/script&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"&lt;/#assign&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="s2">"&lt;@base.layout body=body js=js /&gt;"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Page layout template for FTL files"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>这样新建 .ftl 文件后，输入 <code class="language-plaintext highlighter-rouge">layout:page</code>，页面布局结构就自动生成了。</p>

<p>如图所示：</p>

<p><img src="/images/posts/java/freemarker-layout-snippets.gif" alt="" /></p>

<p>IntelliJ IDEA 也可以用 Live Templates 实现同样的效果。</p>

<p>本文相关代码和示例已上传至 GitHub，见 <a href="https://github.com/mzlogin/learn-spring">https://github.com/mzlogin/learn-spring</a> 的 freemarker-test 目录。</p>]]></content><author><name>朱</name></author><category term="Java" /><summary type="html"><![CDATA[FreeMarker 复用 layout]]></summary></entry><entry><title type="html">DIY｜Mac 搭建 ESP-IDF 开发环境及编译小智 AI</title><link href="https://zwany1.github.io/2025/06/05/diy-xiaozhi-ai-with-mac/" rel="alternate" type="text/html" title="DIY｜Mac 搭建 ESP-IDF 开发环境及编译小智 AI" /><published>2025-06-05T00:00:00+08:00</published><updated>2025-06-05T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/06/05/diy-xiaozhi-ai-with-mac</id><content type="html" xml:base="https://zwany1.github.io/2025/06/05/diy-xiaozhi-ai-with-mac/"><![CDATA[<p>前一阵子在百度 AI 开发者大会上，看到基于小智 AI DIY 玩具的演示，感觉有点意思，想着自己也来试试。</p>

<p>如果只是想烧录现成的固件，乐鑫官方除了提供了 Windows 版本的 <a href="https://www.espressif.com.cn/zh-hans/support/download/other-tools">Flash 下载工具</a> 之外，还提供了基于网页版的 <a href="https://espressif.github.io/esp-launchpad/">ESP LAUNCHPAD</a>，按照说明在 Mac 上也可以使用。</p>

<p>而我想着后期做一些定制，所以还是需要在 Mac 上搭建 ESP-IDF 开发环境，自己编译和烧录固件。而这个在 <a href="https://ccnphfhqs21z.feishu.cn/wiki/F5krwD16viZoF0kKkvDcrZNYnhb">小智 AI 聊天机器人百科全书</a> 中没有详细提及，所以我就记录一下搭建过程，供有需要的朋友参考。</p>

<p>先上一个跑起来后的效果：</p>

<p><img src="/images/posts/ai/xiaozhi-ai.jpg" alt="" /></p>

<h2 id="配置-macos-平台工具链">配置 macOS 平台工具链</h2>

<p>这一步参考乐鑫官方的 <a href="https://docs.espressif.com/projects/esp-idf/zh_CN/v5.4.1/esp32s3/get-started/linux-macos-setup.html">Linux 和 macOS 平台工具链的标准设置</a> 完成，我这里指定了使用 ESP-IDF v5.4.1 版本，编译目标是 ESP32-S3。</p>

<h3 id="第一步安装前置依赖">第一步：安装前置依赖</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>cmake ninja dfu-util ccache python3
</code></pre></div></div>

<h3 id="第二步获取-esp-idf">第二步：获取 ESP-IDF</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> ~/github
<span class="nb">cd</span> ~/github
git clone <span class="nt">-b</span> v5.4.1 <span class="nt">--recursive</span> https://github.com/espressif/esp-idf.git
</code></pre></div></div>

<p>ESP-IDF 将下载至 <code class="language-plaintext highlighter-rouge">~/github/esp-idf</code> 目录。</p>

<h3 id="第三步设置工具">第三步：设置工具</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/github/esp-idf
./install.sh esp32s3
</code></pre></div></div>

<h3 id="第四步设置环境变量">第四步：设置环境变量</h3>

<p>在 ~/.zshrc 中添加以下内容：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">alias </span><span class="nv">get_idf</span><span class="o">=</span><span class="s1">'. $HOME/github/esp-idf/export.sh'</span>
</code></pre></div></div>

<p>然后 <code class="language-plaintext highlighter-rouge">source ~/.zshrc</code> 使其生效。</p>

<p>这样在需要用到 ESP-IDF 环境的时候，只需要在终端中执行 <code class="language-plaintext highlighter-rouge">get_idf</code> 即可。</p>

<p>在执行以上步骤时，如果遇到问题，可以到 <a href="https://docs.espressif.com/projects/esp-idf/zh_CN/v5.4.1/esp32s3/get-started/linux-macos-setup.html">乐鑫官方文档</a> 里看看有没有解决方案。</p>

<h2 id="下载和编译小智-ai-固件">下载和编译小智 AI 固件</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/github
git clone <span class="nt">-b</span> v1.6.2 git@github.com:78/xiaozhi-esp32.git
<span class="nb">cd </span>xiaozhi-esp32
</code></pre></div></div>

<p>然后接入 ESP32-S3 开发板，执行以下命令：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get_idf
idf.py set-target esp32s3
idf.py build
idf.py flash monitor
</code></pre></div></div>

<p>一切顺利的话，会向 ESP32-S3 开发板烧录小智 AI 固件，并且进入监控模式。</p>

<p>至此，就初步能跑起来了。按照提示进行 WiFi 配置和小智 AI 平台的设备绑定，即可开始使用。</p>

<p>如果后续需要定制固件，可以基于 <code class="language-plaintext highlighter-rouge">~/github/xiaozhi-esp32</code> 目录进行修改和编译。若习惯使用 VSCode 进行开发，可以安装 <a href="https://github.com/espressif/vscode-esp-idf-extension">适用于 VSCode 的 ESP-IDF 扩展</a>，这样可以更方便地进行开发和调试。</p>

<h2 id="参考链接">参考链接</h2>

<ul>
  <li><a href="https://www.espressif.com.cn/zh-hans/support/download/other-tools">https://www.espressif.com.cn/zh-hans/support/download/other-tools</a></li>
  <li><a href="https://espressif.github.io/esp-launchpad/">https://espressif.github.io/esp-launchpad/</a></li>
  <li><a href="https://ccnphfhqs21z.feishu.cn/wiki/F5krwD16viZoF0kKkvDcrZNYnhb">https://ccnphfhqs21z.feishu.cn/wiki/F5krwD16viZoF0kKkvDcrZNYnhb</a></li>
  <li><a href="https://docs.espressif.com/projects/esp-idf/zh_CN/v5.4.1/esp32s3/get-started/linux-macos-setup.html">https://docs.espressif.com/projects/esp-idf/zh_CN/v5.4.1/esp32s3/get-started/linux-macos-setup.html</a></li>
  <li><a href="https://github.com/espressif/vscode-esp-idf-extension">https://github.com/espressif/vscode-esp-idf-extension</a></li>
</ul>]]></content><author><name>朱</name></author><category term="DIY" /><summary type="html"><![CDATA[使用 Mac 烧录小智 AI]]></summary></entry><entry><title type="html">Mac mini 外接三方键盘如何微调音量</title><link href="https://zwany1.github.io/2025/05/08/mac-fine-tune-the-volume/" rel="alternate" type="text/html" title="Mac mini 外接三方键盘如何微调音量" /><published>2025-05-08T00:00:00+08:00</published><updated>2025-05-08T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/05/08/mac-fine-tune-the-volume</id><content type="html" xml:base="https://zwany1.github.io/2025/05/08/mac-fine-tune-the-volume/"><![CDATA[<p>用 Mac mini 外接第三方键盘时，音量调节可能会让人感到痛苦。比如，<kbd>Fn + F11</kbd> 和 <kbd>Fn + F12</kbd> 这对音量调节快捷键可能没法用，而基于它们的微调组合键（<kbd>Fn + Option + Shift + F11</kbd> 和 <kbd>Fn + Option + Shift + F12</kbd>）更是想都别想。</p>

<p>我的工作键盘是 IKBC C87，虽然有个 Fn 键，但它和 Mac 键盘的 Fn 完全不是一回事。键盘自带的音量调节组合键只能一格一格地调节，听歌时还好，但在 Coding 时，这“一格”的音量有时就显得过于喧闹，让人无法沉浸式思考。微调音量成了刚需。</p>

<p>最终，<a href="https://karabiner-elements.pqrs.org/">Karabiner-Elements</a> 拯救了我。</p>

<h2 id="设置方法">设置方法</h2>

<p>只需将右 <kbd>Ctrl</kbd> 键映射为 <kbd>Fn</kbd> 键，就能像用苹果妙控键盘一样，正常使用各种基于 Fn 的快捷键，包括音量微调。</p>

<p><img src="/images/posts/mac/mac-karabiner-elements.png" alt="" /></p>

<h2 id="关于-karabiner-elements">关于 Karabiner-Elements</h2>

<p><a href="https://karabiner-elements.pqrs.org/">Karabiner-Elements</a> 是一款强大的键盘映射工具，功能远不止映射单键这么简单。它还能：</p>

<ul>
  <li>创建自定义快捷键组合；</li>
  <li>设计复杂的键盘规则；</li>
  <li>根据不同应用程序或环境动态调整键盘映射。</li>
</ul>

<p>此外，官网还提供了丰富的规则库，按需导入即可：<a href="https://ke-complex-modifications.pqrs.org/">https://ke-complex-modifications.pqrs.org/</a>。</p>

<hr />

<p>现在，我终于可以在 Coding 时享受“刚刚好”的背景音乐，而不用被“一格音量”的霸道支配。</p>

<p>希望能帮到和我一样有此困扰的你。</p>]]></content><author><name>朱</name></author><category term="Mac" /><summary type="html"><![CDATA[Mac mini 外接三方键盘如何微调音量]]></summary></entry><entry><title type="html">Java｜小数据量场景的模糊搜索体验优化</title><link href="https://zwany1.github.io/2025/04/23/search-optimize-in-small-data/" rel="alternate" type="text/html" title="Java｜小数据量场景的模糊搜索体验优化" /><published>2025-04-23T00:00:00+08:00</published><updated>2025-04-23T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/04/23/search-optimize-in-small-data</id><content type="html" xml:base="https://zwany1.github.io/2025/04/23/search-optimize-in-small-data/"><![CDATA[<p>在小数据量场景下，如何优化模糊搜索体验？本文分享一个简单实用的方案，虽然有点“土”，但效果还不错。</p>

<h2 id="场景">场景</h2>

<p>假设有一张表 <code class="language-plaintext highlighter-rouge">t_course</code>，数据量在三到四位数，字段 <code class="language-plaintext highlighter-rouge">name</code> 需要支持模糊搜索。用普通的 <code class="language-plaintext highlighter-rouge">LIKE</code> 语句，比如：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">t_course</span> <span class="k">WHERE</span> <span class="n">name</span> <span class="k">LIKE</span> <span class="s1">'%2025数学高一下%'</span><span class="p">;</span>
</code></pre></div></div>

<p>结果却查不到 <code class="language-plaintext highlighter-rouge">2025年高一数学下学期</code>。这就很尴尬了，用户体验直接拉胯。</p>

<h2 id="方案探索">方案探索</h2>

<h3 id="1-mysql-全文索引">1. MySQL 全文索引</h3>

<p>首先想到 MySQL 的全文索引，但要支持中文分词得改 <code class="language-plaintext highlighter-rouge">ngram_token_size</code> 配置，还得重启数据库。为了不动生产环境配置，果断放弃。</p>

<h3 id="2-elasticsearch">2. Elasticsearch</h3>

<p>接着想到 Elasticsearch，但对这么简单的场景来说，未免有点“杀鸡用牛刀”。于是继续寻找更轻量的方案。</p>

<h3 id="3-自定义分词--mysql-instr">3. 自定义分词 + MySQL INSTR</h3>

<p>最后想到一个“土办法”：先对用户输入进行分词，再用 MySQL 的 <code class="language-plaintext highlighter-rouge">INSTR</code> 函数匹配。简单粗暴，但很实用。</p>

<p><img src="/images/posts/java/search-optimize-in-small-data.drawio.png" alt="" /></p>

<h2 id="实现">实现</h2>

<h3 id="分词工具">分词工具</h3>

<p>一开始用了 <code class="language-plaintext highlighter-rouge">jcseg</code> 分词库，写了个工具类：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JcSegUtils</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">SegmenterConfig</span> <span class="no">CONFIG</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SegmenterConfig</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ADictionary</span> <span class="no">DIC</span> <span class="o">=</span> <span class="nc">DictionaryFactory</span><span class="o">.</span><span class="na">createSingletonDictionary</span><span class="o">(</span><span class="no">CONFIG</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">segment</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ISegment</span> <span class="n">seg</span> <span class="o">=</span> <span class="nc">ISegment</span><span class="o">.</span><span class="na">NLP</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="no">CONFIG</span><span class="o">,</span> <span class="no">DIC</span><span class="o">);</span>
        <span class="n">seg</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">text</span><span class="o">));</span>
        <span class="nc">IWord</span> <span class="n">word</span><span class="o">;</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">word</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">wordText</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">wordText</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">wordText</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>本地测试一切正常，但部署到测试环境后，分词结果却变了！比如：</p>

<ul>
  <li>本地：<code class="language-plaintext highlighter-rouge">[2025, 数学, 高一, 下]</code></li>
  <li>测试环境：<code class="language-plaintext highlighter-rouge">[2025, 数, 学, 高, 1, 下]</code></li>
</ul>

<p>原因是 <code class="language-plaintext highlighter-rouge">jcseg</code> 在 jar 包中加载默认配置和词库时出问题了。网上的解决方案大多是外置词库，但我懒得折腾，决定自己撸个简易分词工具。</p>

<h3 id="简易分词工具">简易分词工具</h3>

<p>最终实现如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WordSegmentationUtils</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="no">DICT</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COURSE_SEARCH_KEYWORD_LIST</span> <span class="o">=</span> <span class="s">"数学,物理,化学,生物,地理,历史,政治,英语,语文,高中,高一,高二,高三"</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="no">DICT</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2018</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2099</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="no">DICT</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="no">DICT</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="no">COURSE_SEARCH_KEYWORD_LIST</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">)));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">segment</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">text</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="o">}</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">segments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">segments</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">word</span> <span class="o">:</span> <span class="no">DICT</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">segments</span> <span class="o">=</span> <span class="n">segment</span><span class="o">(</span><span class="n">segments</span><span class="o">,</span> <span class="n">word</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">segments</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">segment</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">segments</span><span class="o">,</span> <span class="nc">String</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">newSegments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">segment</span> <span class="o">:</span> <span class="n">segments</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">segment</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">word</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">newSegments</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
                <span class="nc">String</span><span class="o">[]</span> <span class="n">split</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">split</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">newSegments</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">trim</span><span class="o">());</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">newSegments</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">segment</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">newSegments</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这个工具基于一个简单的词典 <code class="language-plaintext highlighter-rouge">DICT</code>，按词典中的词对输入文本进行分割。比如：</p>

<ul>
  <li>输入：<code class="language-plaintext highlighter-rouge">2025数学高一下</code></li>
  <li>输出：<code class="language-plaintext highlighter-rouge">[2025, 数学, 高一, 下]</code></li>
</ul>

<h3 id="效果验证">效果验证</h3>

<p>现在，无论用户输入以下哪种形式，都能成功匹配到 <code class="language-plaintext highlighter-rouge">2025年高一数学下学期</code>：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">2025高一数学下</code></li>
  <li><code class="language-plaintext highlighter-rouge">2025 高一 数学</code></li>
  <li><code class="language-plaintext highlighter-rouge">数学高一2025</code></li>
</ul>

<h2 id="小结">小结</h2>

<p>这个方案虽然简单，但在小数据量场景下，性能和体验都能满足需求，且实现成本低。如果遇到特殊情况，可以通过动态更新词典来解决。</p>

<p>当然，这种“土办法”并不适合复杂场景。如果需求升级，可以再考虑 MySQL 全文索引或 Elasticsearch。</p>

<p>最后，自己一个人负责开发和运维就是任性！如果有团队一起评审，这方案可能早就被否了吧……额，达摩克利斯之剑高悬。</p>]]></content><author><name>朱</name></author><category term="Java" /><summary type="html"><![CDATA[小数据量场景的模糊搜索体验优化]]></summary></entry><entry><title type="html">家里老人迷信医疗广告？我可能找到办法了</title><link href="https://zwany1.github.io/2025/03/21/solutions-for-elders-believe-in-medical-ads/" rel="alternate" type="text/html" title="家里老人迷信医疗广告？我可能找到办法了" /><published>2025-03-21T00:00:00+08:00</published><updated>2025-03-21T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/03/21/solutions-for-elders-believe-in-medical-ads</id><content type="html" xml:base="https://zwany1.github.io/2025/03/21/solutions-for-elders-believe-in-medical-ads/"><![CDATA[<p>有没有这样一种奇妙体验：家里老人对你的忠告嗤之以鼻，却对网络医疗广告深信不疑？仿佛那些”三天速效”“纯天然”“祖传秘方”字样自带某种魔力，能让他们心甘情愿掏空钱包？</p>

<p>我爸就是这样。医院检查出肠道息肉后，他不愿接受正规治疗，却在网上找了个不知名的乡镇医院，买了一堆贵得离谱的中药。当我劝他去本市三甲医院时，我们吵了一架，不欢而散。</p>

<p>我百思不得其解：为什么长辈会信任网上随机广告，胜过亲生儿女的劝告？是年代差异让他们天然信任媒体？是搜索引擎大品牌的背书效应？还是他们骨子里相信”酒香也怕巷子深，神医总在小诊所”？</p>

<p>曾经，我尝试给他安装丁香医生，希望提供专业的医疗参考。结果他嫌上面评论太少，不够可信。转头却给我展示抖音上的”体外无痛胃肠检查”广告——零评论，明显广告标识。我内心：这双标技术堪称奥运冠军水平啊！</p>

<p>绝望之际，我发现了转机。</p>

<p>一天晚上，我爸向我展示他用”豆包”AI制作的视频。灵光乍现！我让他用豆包查询那个”神奇”的体外检查技术。豆包给出了客观分析，而他竟然接受了这个意见！</p>

<p>第二天他主动用豆包查询其他健康问题，我立刻顺水推舟：”以后不用上百度了，直接问豆包就好。”他居然欣然接受！</p>

<p>所以，我所谓的方法其实很简单：<strong>用 AI 助手替代浏览器和搜索引擎</strong>。无论是豆包、DeepSeek 还是其他 AI 产品，它们提供简洁明了的单一答案，不会展示五花八门的广告链接，也（暂时）不会被商业利益左右。</p>

<p>感谢技术进步，我终于不用在”爸，这是骗人的”和”儿子，你懂什么”之间无限循环了。</p>

<p>类似的救赎，tk 教主的经历显然更加硬核，但我可能来不及去建立那样的信任了：</p>

<p><img src="/images/posts/ai/tk-save-his-mother.jpg" alt="" /></p>

<p><img src="/images/posts/ai/tk-save-his-mother-2.jpg" alt="" /></p>]]></content><author><name>朱</name></author><category term="AI" /><summary type="html"><![CDATA[家里的老人相信医疗广告多过于我，不过，我可能找到解决方案来帮助他们了。]]></summary></entry><entry><title type="html">iOS｜解决 setBrightness 调节屏幕亮度不生效的问题</title><link href="https://zwany1.github.io/2025/02/26/ios-setbrightness-not-work/" rel="alternate" type="text/html" title="iOS｜解决 setBrightness 调节屏幕亮度不生效的问题" /><published>2025-02-26T00:00:00+08:00</published><updated>2025-02-26T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/02/26/ios-setbrightness-not-work</id><content type="html" xml:base="https://zwany1.github.io/2025/02/26/ios-setbrightness-not-work/"><![CDATA[<p>在包含视频播放功能的 App 中，一种常见的交互是在播放器界面的左侧上下滑动调节屏幕亮度，右侧上下滑动调节音量。我们的 iOS App 里也是这样设计的，但最近在测试过程中，发现亮度调节不生效了。</p>

<h2 id="摸索之路">摸索之路</h2>

<p>代码里面调节亮度的实现是这样的：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setBrightnessUp</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">brightness</span> <span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">brightness</span> <span class="o">+=</span> <span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setBrightnessDown</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">brightness</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">UIScreen</span> <span class="nf">mainScreen</span><span class="p">].</span><span class="n">brightness</span> <span class="o">-=</span> <span class="mi">0</span><span class="p">.</span><span class="mo">01</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这个实现在较早之前是没有问题的，那我首先想到比较可能是因为系统的更新，对这个 API 做了变更。于是先查阅了 <a href="https://developer.apple.com/documentation/uikit/uiscreen/brightness?language=objc">UIKit/UIScreen/brightness 的官方文档</a>，里面只提到了 brightness 属性只在 main screen 上被支持，取值范围是 [0.0, 1.0]，以及亮度调节后，直到锁屏后才会失效——即使用户在锁屏之前已经关闭了 App。并没有看到什么值得特别留意的。</p>

<p>然后继续看代码里的 UIScreen.mainScreen，这个属性被标记为：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">API_DEPRECATED</span><span class="p">(</span><span class="s">"Use a UIScreen instance found through context instead: i.e, view.window.windowScene.screen"</span><span class="p">,</span> <span class="n">ios</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">API_TO_BE_DEPRECATED</span><span class="p">),</span> <span class="n">visionos</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">API_TO_BE_DEPRECATED</span><span class="p">))</span>
</code></pre></div></div>

<p>但当前在我使用的 SDK 18.2 版本中，这个属性应仍可正常使用。</p>

<p>在 Google 和 StackOverflow 找了一圈，大家讨论亮度调节不生效主要集中以下方面：</p>

<ul>
  <li><a href="https://stackoverflow.com/questions/54229300/not-able-to-set-brightness-when-app-enter-in-background-can-any-one-have-any-id">后台调用不生效；</a></li>
  <li><a href="https://stackoverflow.com/questions/12362885/ios-uiscreen-setbrightness-doesnt-work">模拟器上调节不生效；</a></li>
  <li><a href="https://stackoverflow.com/questions/61765014/why-cannot-i-set-uiscreen-main-brightness">viewDidLoad and viewWillAppear 中调用不生效；</a></li>
  <li>如何优雅地在 App 退出后恢复原有亮度；</li>
</ul>

<p>也没有找到什么能匹配我的场景的解决方案。</p>

<p>加了一些日志，在调节亮度前后分别打印了 brightness 的值，发现它在调用 setBrightness 方法后并没有发生变化，也没有报错和告警，看起来就像是这个方法根本没有被调用一样。</p>

<p>也做了一些其它尝试，比如把调整亮度的代码显式调度到主线程、使用 <code class="language-plaintext highlighter-rouge">view.window.windowScene.screen</code> 替代 <code class="language-plaintext highlighter-rouge">UIScreen.mainScreen</code> 等，但都没有效果。</p>

<p>无奈之下，我问了 GitHub Copilot 一嘴，它的回答是这样的：</p>

<p><img src="/images/posts/ios/copilot-ios-setbrightness-not-work.png" alt="" /></p>

<p>我按它的建议检查了权限，确认了不存在权限问题。</p>

<p>有点绝望之际，看到它提供的代码里调整亮度的粒度是 0.1，而我的代码里是 0.01，<strong>于是我尝试将粒度改为 0.1，然后奇迹发生了，亮度调节生效了</strong>。</p>

<p>这就有点匪夷所思了……于是我又尝试了其它的粒度值，结果如下：</p>

<ul>
  <li>0.01，不生效；</li>
  <li>0.02，不生效；</li>
  <li>0.03 及以上，生效，但是从输出可以看到，<strong>实际调整后的亮度值都是 0.05 的倍数，即 0.05、0.1、0.15、0.2……</strong>，而不是 0.03、0.06、0.09、0.12……</li>
</ul>

<p>我找到安装了以前老版本 App 的一个老平板（iOS 10.3.3），在上面测试了一下，发现在这个版本上，0.01 的调节粒度是可以生效的。</p>

<p><strong>也就是说，在 iOS (10.3.3, 18.2) 之间靠近后者的某个版本上，[UIScreen mainScreen].brightness 的调节粒度发生了变化，由 0.01 变为了 0.05。</strong></p>

<p>至此破案了，顺便吐槽一下，官方文档里对此毫无提及，实在是……略坑。</p>

<h2 id="参考">参考</h2>

<ul>
  <li><a href="https://developer.apple.com/documentation/uikit/uiscreen/brightness?language=objc">https://developer.apple.com/documentation/uikit/uiscreen/brightness?language=objc</a></li>
  <li><a href="https://stackoverflow.com/questions/54229300/not-able-to-set-brightness-when-app-enter-in-background-can-any-one-have-any-id">https://stackoverflow.com/questions/54229300/not-able-to-set-brightness-when-app-enter-in-background-can-any-one-have-any-id</a></li>
  <li><a href="https://stackoverflow.com/questions/12362885/ios-uiscreen-setbrightness-doesnt-work">https://stackoverflow.com/questions/12362885/ios-uiscreen-setbrightness-doesnt-work</a></li>
  <li><a href="https://stackoverflow.com/questions/61765014/why-cannot-i-set-uiscreen-main-brightness">https://stackoverflow.com/questions/61765014/why-cannot-i-set-uiscreen-main-brightness</a></li>
</ul>]]></content><author><name>朱</name></author><category term="iOS" /><summary type="html"><![CDATA[iOS App 中调用 setBrightness 方法不生效，最终在 GitHub Copilot 的「协助」下解决了这个问题。]]></summary></entry><entry><title type="html">iOS｜记一名 iOS 开发新手的前两次 App 审核经历</title><link href="https://zwany1.github.io/2025/02/25/ios-app-review/" rel="alternate" type="text/html" title="iOS｜记一名 iOS 开发新手的前两次 App 审核经历" /><published>2025-02-25T00:00:00+08:00</published><updated>2025-02-25T00:00:00+08:00</updated><id>https://zwany1.github.io/2025/02/25/ios-app-review</id><content type="html" xml:base="https://zwany1.github.io/2025/02/25/ios-app-review/"><![CDATA[<p>说来惭愧，独立支撑公司的软件系统已经一年有余，多数的精力都在开发和迭代 Web 服务与 Android 端，对于 iOS App 则是一直没有更新，遇到相关的 bug 反馈也是能拖就拖——毕竟，大多数情况下找个 workaround 还是不难的。</p>

<p>回过头想想，可能潜意识里一直有点犯怵，觉得 iOS 开发是自己的薄弱环节，所以总想着等有时间，再多学一点相关的东西，准备得更充分、更有自信能处理好了，再去更新。可一直这样下去也不是办法，所以春节前结合一些业务需求，我决定逼自己一把，尽快把 iOS App 更新一下。</p>

<p>面对一个个所谓难题：</p>

<ul>
  <li>Objective-C 的语法一阵没用又快忘光了——突击复习了一波；</li>
  <li>API 的细节不熟悉——看文档，参考老代码里的写法；</li>
  <li>有一些变动不确定是否影响兼容性——查文档，问老同事，做测试；</li>
  <li>……</li>
</ul>

<p>然后在这个 AI 大行其道的时代，作为尊贵的 GitHub Copilot Pro 用户，在插件的辅助下光速添加了一个新的小功能，修复了一些 bug 后，我向 App Store Connect 提交了我的第一次版本审核，本以为需要经过漫长的等待，结果……</p>

<p><img src="/images/posts/ios/app-review-1.png" alt="" /></p>

<p>事情出乎意料地顺利，几个小时就通过了，这玩意也有新手保护期？</p>

<p>满怀得意我心欢喜，于是一鼓作气把囤积已久的几个 feature 给做了，然后兴冲冲地提交了第二次版本审核，结果……</p>

<p>几个小时后第一次被驳回，原因是：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Guideline 3.1.1 - Business - Payments - In-App Purchase

We found in our review that your app or its metadata provides access to mechanisms other than in-app purchase for purchases or subscriptions to be used in the app, which does not comply with the App Review Guidelines. Specifically:


- Your app's binary includes the following call-to-action and/or URL that directs users to external mechanisms for purchases or subscriptions to be used in the app:


User have to contact customer service to puchase credits.
</code></pre></div></div>

<p>看截图我查到了这是几年前参考一个大厂 App 实现的效果，在用户余额不足时，弹出一个提示框，上面有两个按钮，一个点击后展示了客服的联系方式，一个是「取消」，点击后跳转到充值页面。</p>

<p>我以为这里面的主要问题点是没有明确的「去充值」入口，导致审核人员以为用户无法直接充值，必须联系客服，于是我添加了一个「去充值」的按钮，将「取消」按钮的动作改为隐藏提示框，然后再次提交审核，结果几个小时后又被驳回了，原因仍然是：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Your app's "xxx" page includes the following call-to-action and/or URL that directs users to external mechanisms for purchases or subscriptions to be used in the app
</code></pre></div></div>

<p>不过发过来的消息里还有这样一段：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Bug Fix Submissions

The issues we've identified below are eligible to be resolved on your next update. If this submission includes bug fixes and you'd like to have it approved at this time, reply to this message and let us know. You do not need to resubmit your app for us to proceed.


Alternatively, if you'd like to resolve these issues now, please review the details, make the appropriate changes, and resubmit.
</code></pre></div></div>

<p>其实，这时候我只要回复个消息，说我这次提交包含了一些 bug 修复，希望能通过审核，下次我再修复这个问题，就妥了……</p>

<p>但我当时脑子里不知道咋想的，可能是觉得这么个小问题，这次解决掉算了，然后就又改了一版，将那个跳转到客服联系方式的按钮去掉，又提交了一版，这时候我以为这把稳了，就收工等消息了。</p>

<p>回家正刷着沙雕视频呢，弹出来消息，又被拒了，这回是什么原因呢……</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Guideline 2.1 - Performance - App Completeness
Issue Description


The app exhibited one or more bugs that would negatively impact App Store users.


Bug description: unable to load "xxx"
</code></pre></div></div>

<p>我人都懵了，同时懊恼万分，真不应该装这个逼，就该回个消息，让审核员先通过再说。</p>

<p>话说回来，这个 xxx 功能已经在线上跑了几年了，最近也没改过，最后思来想去，怀疑可能是审核员当时遇上了什么网络波动之类的，导致没加载出来。</p>

<p>没辙，我只好在一些设备上复测了一下，保存了一些该功能正常使用的截图，然后回复给审核员，表明这个功能经我多次测试是正常的，已经上线运行了几年且最近没有修改过，希望审核员能再次确认，如果可以的话帮忙通过审核。</p>

<p>然后这回真的是漫长的等待，等了两天多，度过了一个忐忑的周末后，终于在周一一大早盼来了好消息。这一个版本的审核历时五天，经过了三轮被拒，总算是磕磕绊绊地通过了：</p>

<p><img src="/images/posts/ios/app-review-2.png" alt="" /></p>

<p>以上就是我这个 iOS 开发新手的前两次 App 审核经历，总结一下，主要有以下几点：</p>

<ul>
  <li>充分测试，保证功能的完整和稳定；</li>
  <li>对 <a href="https://developer.apple.com/cn/distribute/app-review/">App 审核</a> 的相关文档保持关注，避免一些容易被驳回的问题；</li>
  <li>有问题及时回复审核员，解释清楚问题所在，提供相关的截图、视频等证据。</li>
</ul>

<p>总的来讲，相比 Android App 需要提交到各家应用市场，然后面临不同的审核标准和结果，iOS App 的审核体验相对还是不错的，毕竟只用面对唯一的渠道和标准。</p>]]></content><author><name>朱</name></author><category term="iOS" /><summary type="html"><![CDATA[记一名 iOS 开发新手的前两次 App 审核经历]]></summary></entry></feed>